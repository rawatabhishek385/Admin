{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .grade-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .grade-table th, .grade-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .grade-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .marks-input {
      width: 60px;
      text-align: center;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background-color: white;
    }
    .marks-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    .marks-input.has-marks {
      color: black;
      background-color: #29ce4f;
      border-color: #09cd36;
    }
 /* Summary Cards */
.summary-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.summary-card {
    flex: 1;
    min-width: 250px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
}
.summary-stats {
    display: flex;
    gap: 20px;
    flex-wrap: nowrap;
    margin-bottom: 10px;
}
.summary-stat {
    background: white;
    padding: 10px 15px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
    min-width: 80px;
    flex-grow: 1;
    text-align: center;
}
.summary-stat strong {
    display: block;
    margin-bottom: 5px;
    color: #495057;
}
.summary-highlight {
    background-color: #e7f3ff;
    font-weight: bold;
}

.summary-container .summary-card:last-child {
    flex-grow: 0;
    flex-shrink: 1;
    min-width: 250px;
}

    .section-header {
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
      margin-top: 30px;
      margin-bottom: 15px;
      color: #343a40;
    }

    .submit-row {
      margin-top: 30px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      text-align: right;
    }
    .submit-row .button {
      padding: 10px 15px;
      background: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-left: 10px;
      font-size: 14px;
      line-height: 1.5;
    }
    .submit-row .default {
      background: #e81212;
    }
    .submit-row .button:hover {
      opacity: 0.9;
    }
    .submit-row .button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .total-row {
      background-color: #e9ecef;
      font-weight: bold;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <h1>Grade Answers for {{ candidate.name }} ({{ candidate.army_no }})</h1>

  <div class="summary-container">
    <div class="summary-card">
      <h3>Primary Exam Summary</h3>
      <div class="summary-stats">
        <div class="summary-stat">
          <strong>Viva 1</strong>
          {{ candidate.viva_1 }}
        </div>
        <div class="summary-stat">
          <strong>Practical 1</strong>
          {{ candidate.practical_1 }}
        </div>
        <div class="summary-stat summary-highlight">
          <strong>Primary Total</strong>
          <span id="primary-summary-total">{{ candidate.viva_1|add:candidate.practical_1|add:primary_total_obtained }}</span>
        </div>
      </div>
    </div>

    <div class="summary-card">
      <h3>Secondary Exam Summary</h3>
      <div class="summary-stats">
        <div class="summary-stat">
          <strong>Viva 2</strong>
          {{ candidate.viva_2 }}
        </div>
        <div class="summary-stat">
          <strong>Practical 2</strong>
          {{ candidate.practical_2 }}
        </div>
        <div class="summary-stat summary-highlight">
          <strong>Secondary Total</strong>
          <span id="secondary-summary-total">{{ candidate.viva_2|add:candidate.practical_2|add:secondary_total_obtained }}</span>
        </div>
      </div>
    </div>

    <div class="summary-card">
      <h3>Grand Total/200</h3>
      <div class="summary-stats">
        <div class="summary-stat summary-highlight" style="min-width: 200px; text-align: center;">
          <strong>Overall Total</strong>
          <span id="grand-summary-total">
            {{ candidate.viva_1|add:candidate.practical_1|add:primary_total_obtained|add:candidate.viva_2|add:candidate.practical_2|add:secondary_total_obtained }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <form method="post" id="grading-form">
    {% csrf_token %}
    
    {% if primary_answers %}
    <h2 class="section-header">Primary Questions</h2>
    <table class="grade-table">
      <thead>
        <tr>
          <th>Question</th>
          <th>Candidate's Answer</th>
          <th>Correct Answer</th>
          <th>Max Marks</th>
          <th>Marks Obtained</th>
        </tr>
      </thead>
      <tbody>
        {% for answer in primary_answers %}
        <tr>
          <td>{{ answer.question.question }}</td>
          <td>{{ answer.answer|default:"Not answered" }}</td>
          <td>{{ answer.question.correct_answer|default:"N/A" }}</td>
          <td style="text-align: center;">{{ answer.question.max_marks }}</td>
          <td style="text-align: center;">
            <input type="number" name="marks_{{ answer.id }}"
            value="{% if answer.marks_obt is not None %}{{ answer.marks_obt }}{% else %}0{% endif %}"
            min="0" max="{{ answer.question.max_marks }}"
            class="marks-input"
            data-max-marks="{{ answer.question.max_marks }}">
          </td>
        </tr>
        {% endfor %}
        <tr class="total-row">
          <td colspan="3" style="text-align: right;"><strong>Primary Total:</strong></td>
          <td style="text-align: center;"><strong>{{ primary_total_max }}</strong></td>
          <td style="text-align: center;"><strong id="primary-total">{{ primary_total_obtained }}</strong></td>
        </tr>
      </tbody>
    </table>
    {% endif %}

    {% if secondary_answers %}
    <h2 class="section-header">Secondary Questions</h2>
    <table class="grade-table">
      <thead>
        <tr>
          <th>Question</th>
          <th>Candidate's Answer</th>
          <th>Correct Answer</th>
          <th>Max Marks</th>
          <th>Marks Obtained</th>
        </tr>
      </thead>
      <tbody>
        {% for answer in secondary_answers %}
        <tr>
          <td>{{ answer.question.question }}</td>
          <td>{{ answer.answer|default:"Not answered" }}</td>
          <td>{{ answer.question.correct_answer|default:"N/A" }}</td>
          <td style="text-align: center;">{{ answer.question.max_marks }}</td>
          <td style="text-align: center;">
            <input type="number" name="marks_{{ answer.id }}"
            value="{% if answer.marks_obt is not None %}{{ answer.marks_obt }}{% else %}0{% endif %}"
            min="0" max="{{ answer.question.max_marks }}"
            class="marks-input"
            data-max-marks="{{ answer.question.max_marks }}">
          </td>
        </tr>
        {% endfor %}
        <tr class="total-row">
          <td colspan="3" style="text-align: right;"><strong>Secondary Total:</strong></td>
          <td style="text-align: center;"><strong>{{ secondary_total_max }}</strong></td>
          <td style="text-align: center;"><strong id="secondary-total">{{ secondary_total_obtained }}</strong></td>
        </tr>
      </tbody>
    </table>
    {% endif %}

    <div class="submit-row">
      <input type="submit" value="Save Grades" class="button default" id="submit-button" {% if not all_marks_assigned %}disabled{% endif %}>
      <a href="{% url 'admin:exams_candidate_change' candidate.id %}" class="button">Back to Candidate</a>
    </div>
  </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('grading-form');
  const marksInputs = form.querySelectorAll('.marks-input');
  const primaryTotalElem = document.getElementById('primary-total');
  const secondaryTotalElem = document.getElementById('secondary-total');
  const summaryTotalElem = document.getElementById('summary-total');
  const submitButton = document.getElementById('submit-button');
  
  // Function to update input styling based on whether it has a value
  function updateInputStyle(input) {
    if (input.value.trim() !== "" && input.value !== "0") {
      input.classList.add('has-marks');
    } else {
      input.classList.remove('has-marks');
    }
  }
  
  // Function to check if all marks are assigned (not 0)
  function checkAllMarksAssigned() {
    let allAssigned = true;
    
    marksInputs.forEach(input => {
      if (input.value === "0" || input.value.trim() === "") {
        allAssigned = false;
      }
    });
    
    return allAssigned;
  }
  
  // Function to update submit button state
  function updateSubmitButton() {
    if (checkAllMarksAssigned()) {
      submitButton.disabled = false;
    } else {
      submitButton.disabled = true;
    }
  }
  
  // Initialize all input fields
  marksInputs.forEach(input => {
    // Set default value to 0 if empty
    if (input.value.trim() === "" || input.value === "None" || input.value === "null") {
      input.value = "0";
    }
    
    // Apply styling based on value
    updateInputStyle(input);
    
    // Add event listeners
    input.addEventListener('input', function() {
      const maxMarks = parseInt(this.getAttribute('data-max-marks'));
      let value = this.value.trim();
      
      // Validate input
      if (value !== "") {
        let numericValue = parseInt(value);
        if (isNaN(numericValue) || numericValue < 0) {
          this.value = 0;
          numericValue = 0;
        } else if (numericValue > maxMarks) {
          this.value = maxMarks;
          numericValue = maxMarks;
        }
      }
      
      updateInputStyle(this);
      updateTotals();
      updateSubmitButton();
    });
    
    input.addEventListener('change', function() {
      updateInputStyle(this);
      updateTotals();
      updateSubmitButton();
    });
  });
  
  // Calculate and update totals
  function updateTotals() {
    let primaryTotal = 0;
    let secondaryTotal = 0;
    
    // Calculate primary total
    const primaryTables = form.querySelectorAll('.grade-table');
    if (primaryTables.length > 0) {
      const primaryInputs = primaryTables[0].querySelectorAll('.marks-input');
      primaryInputs.forEach(input => {
        const value = parseInt(input.value);
        if (!isNaN(value)) {
          primaryTotal += value;
        }
      });
    }
    
    // Calculate secondary total
    if (primaryTables.length > 1) {
      const secondaryInputs = primaryTables[1].querySelectorAll('.marks-input');
      secondaryInputs.forEach(input => {
        const value = parseInt(input.value);
        if (!isNaN(value)) {
          secondaryTotal += value;
        }
      });
    }
    
    // Update displayed totals
    if (primaryTotalElem) primaryTotalElem.textContent = primaryTotal;
    if (secondaryTotalElem) secondaryTotalElem.textContent = secondaryTotal;
    
    // Update summary total (viva + practical + question totals)
    const vivaPracticalTotal = {{ candidate.viva_1 }} + {{ candidate.viva_2 }} + {{ candidate.practical_1 }} + {{ candidate.practical_2 }};
    const grandTotal = vivaPracticalTotal + primaryTotal + secondaryTotal;
    if (summaryTotalElem) summaryTotalElem.textContent = grandTotal;
  }
  
  // Initialize totals and submit button state
  updateTotals();
  updateSubmitButton();
  
  // Add form validation
  form.addEventListener('submit', function(e) {
    let hasErrors = false;
    
    marksInputs.forEach(input => {
      const value = input.value.trim();
      const maxMarks = parseInt(input.getAttribute('data-max-marks'));
      
      if (value !== "") {
        const numericValue = parseInt(value);
        if (isNaN(numericValue) || numericValue < 0 || numericValue > maxMarks) {
          hasErrors = true;
          input.style.borderColor = 'red';
        } else {
          input.style.borderColor = '';
        }
      }
    });
    
    if (hasErrors) {
      e.preventDefault();
      alert('Please fix the invalid marks before submitting.');
    }
  });
});
</script>
{% endblock %}