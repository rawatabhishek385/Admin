{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .grade-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .grade-table th, .grade-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .grade-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .marks-input {
      width: 60px;
      text-align: center;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background-color: white;
    }
    .marks-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    .marks-input.has-marks {
      color: black;
      background-color: #29ce4f;
      border-color: #09cd36;
    }
    /* ✅ NEW: Always green when auto-checked (MCQ/TF), even if 0 */
    .marks-input.checked {
      color: black;
      background-color: #29ce4f;
      border-color: #09cd36;
    }
    /* NEW: Force green rows for auto-evaluated questions */
    .auto-evaluated {
      background-color: #d4edda !important;
    }
 /* Summary Cards */
.summary-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.summary-card {
    flex: 1;
    min-width: 250px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
}
.summary-stats {
    display: flex;
    gap: 20px;
    flex-wrap: nowrap;
    margin-bottom: 10px;
}
.summary-stat {
    background: white;
    padding: 10px 15px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
    min-width: 80px;
    flex-grow: 1;
    text-align: center;
}
.summary-stat strong {
    display: block;
    margin-bottom: 5px;
    color: #495057;
}
.summary-highlight {
    background-color: #e7f3ff;
    font-weight: bold;
}

.summary-container .summary-card:last-child {
    flex-grow: 0;
    flex-shrink: 1;
    min-width: 250px;
}

    .section-header {
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
      margin-top: 30px;
      margin-bottom: 15px;
      color: #343a40;
    }

    .submit-row {
      margin-top: 30px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      text-align: right;
    }
    .submit-row .button {
      padding: 10px 15px;
      background: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-left: 10px;
      font-size: 14px;
      line-height: 1.5;
    }
    .submit-row .default {
      background: #e81212;
    }
    .submit-row .button:hover {
      opacity: 0.9;
    }
    .submit-row .button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    .total-row {
      background-color: #e9ecef;
      font-weight: bold;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <h1>Grade Answers for {{ candidate.name }} ({{ candidate.army_no }})</h1>

  <div class="summary-container">
    {# summary cards unchanged #}
  </div>

  <form method="post" id="grading-form">
    {% csrf_token %}
    
    {# ✅ Primary grouped by part #}
    {% if primary_groups %}
    <h2 class="section-header">Primary Questions</h2>
    {% for label, group in primary_groups.items %}
      {% if group %}
      <h3>{{ label }}</h3>
      <table class="grade-table">
        <thead>
          <tr>
            <th>Question</th>
            <th>Candidate's Answer</th>
            <th>Correct Answer</th>
            <th>Max Marks</th>
            <th>Marks Obtained</th>
          </tr>
        </thead>
        <tbody>
          {% for answer in group %}
          <tr>
            <td>{{ answer.question.question }}</td>
            <td class="cand-ans">{{ answer.answer|default:"Not answered" }}</td>
            <td class="corr-ans">{{ answer.question.correct_answer|default:"N/A" }}</td>
            <td class="max-marks" style="text-align: center;">{{ answer.question.max_marks }}</td>
            <td style="text-align: center;">
              <input type="number" name="marks_{{ answer.id }}"
              value="{% if answer.marks_obt is not None %}{{ answer.marks_obt }}{% else %}0{% endif %}"
              min="0" max="{{ answer.question.max_marks }}"
              class="marks-input"
              data-max-marks="{{ answer.question.max_marks }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    {% endfor %}
    {% endif %}

    {# ✅ Secondary grouped by part #}
    {% if secondary_groups %}
    <h2 class="section-header">Secondary Questions</h2>
    {% for label, group in secondary_groups.items %}
      {% if group %}
      <h3>{{ label }}</h3>
      <table class="grade-table">
        <thead>
          <tr>
            <th>Question</th>
            <th>Candidate's Answer</th>
            <th>Correct Answer</th>
            <th>Max Marks</th>
            <th>Marks Obtained</th>
          </tr>
        </thead>
        <tbody>
          {% for answer in group %}
          <tr>
            <td>{{ answer.question.question }}</td>
            <td class="cand-ans">{{ answer.answer|default:"Not answered" }}</td>
            <td class="corr-ans">{{ answer.question.correct_answer|default:"N/A" }}</td>
            <td class="max-marks" style="text-align: center;">{{ answer.question.max_marks }}</td>
            <td style="text-align: center;">
              <input type="number" name="marks_{{ answer.id }}"
              value="{% if answer.marks_obt is not None %}{{ answer.marks_obt }}{% else %}0{% endif %}"
              min="0" max="{{ answer.question.max_marks }}"
              class="marks-input"
              data-max-marks="{{ answer.question.max_marks }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    {% endfor %}
    {% endif %}

    <div class="submit-row">
      <input type="submit" value="Save Grades" class="button default" id="submit-button" {% if not all_marks_assigned %}disabled{% endif %}>
      <a href="{% url 'admin:exams_candidate_change' candidate.id %}" class="button">Back to Candidate</a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('grading-form');
  const marksInputs = form.querySelectorAll('.marks-input');
  const primaryTotalElem = document.getElementById('primary-total');
  const secondaryTotalElem = document.getElementById('secondary-total');
  const summaryTotalElem = document.getElementById('summary-total');
  const submitButton = document.getElementById('submit-button');
  
  // -----------------------------
  // ✅ Auto-assign for MCQ / True-False
  // -----------------------------
  document.querySelectorAll('table.grade-table').forEach((table) => {
    const rows = table.querySelectorAll('tbody tr');
    const sectionLabel = table.previousElementSibling?.textContent?.trim().toLowerCase();

    rows.forEach((row) => {
      const candAnsElem = row.querySelector('.cand-ans');
      const corrAnsElem = row.querySelector('.corr-ans');
      const maxMarksElem = row.querySelector('.max-marks');
      const input = row.querySelector('.marks-input');

      if (candAnsElem && corrAnsElem && input && maxMarksElem) {
        const candAns = candAnsElem.textContent.trim().toLowerCase();
        const corrAns = corrAnsElem.textContent.trim().toLowerCase();
        const maxMarks = parseInt(maxMarksElem.textContent);

        if (sectionLabel.includes("mcq") || sectionLabel.includes("true/false")) {
          if (candAns && corrAns && candAns === corrAns) {
            input.value = maxMarks;   // correct → full marks
          } else {
            input.value = 0;          // wrong → zero
          }
          input.classList.add('checked');   // ✅ stays green even if 0
          input.setAttribute('readonly', 'readonly');
        } else {
          if (input.value === "0" || input.value === "" || input.value === "None") {
            input.value = 0;
          }
        }
      }
    });
  });

  // -----------------------------

  // Function to update input styling (skip .checked ones)
  function updateInputStyle(input) {
    if (input.classList.contains('checked')) return; // don't override MCQ/TF
    if (input.value.trim() !== "" && input.value !== "0") {
      input.classList.add('has-marks');
    } else {
      input.classList.remove('has-marks');
    }
  }
  
  function checkAllMarksAssigned() {
    let allAssigned = true;
    marksInputs.forEach(input => {
      if (input.value === "0" || input.value.trim() === "") {
        allAssigned = false;
      }
    });
    return allAssigned;
  }
  
  function updateSubmitButton() {
    submitButton.disabled = !checkAllMarksAssigned();
  }
  
  marksInputs.forEach(input => {
    if (input.value.trim() === "" || input.value === "None" || input.value === "null") {
      input.value = "0";
    }
    updateInputStyle(input);
    input.addEventListener('input', function() {
      if (!this.classList.contains('checked')) {
        const maxMarks = parseInt(this.getAttribute('data-max-marks'));
        let value = this.value.trim();
        if (value !== "") {
          let numericValue = parseInt(value);
          if (isNaN(numericValue) || numericValue < 0) {
            this.value = 0;
            numericValue = 0;
          } else if (numericValue > maxMarks) {
            this.value = maxMarks;
            numericValue = maxMarks;
          }
        }
        updateInputStyle(this);
        updateTotals();
        updateSubmitButton();
      }
    });
    input.addEventListener('change', function() {
      if (!this.classList.contains('checked')) {
        updateInputStyle(this);
        updateTotals();
        updateSubmitButton();
      }
    });
  });
  
  function updateTotals() {
    let primaryTotal = 0;
    let secondaryTotal = 0;

    document.querySelectorAll('h2.section-header:contains("Primary") ~ table.grade-table').forEach(table => {
      table.querySelectorAll('.marks-input').forEach(input => {
        const value = parseInt(input.value);
        if (!isNaN(value)) primaryTotal += value;
      });
    });

    document.querySelectorAll('h2.section-header:contains("Secondary") ~ table.grade-table').forEach(table => {
      table.querySelectorAll('.marks-input').forEach(input => {
        const value = parseInt(input.value);
        if (!isNaN(value)) secondaryTotal += value;
      });
    });

    if (primaryTotalElem) primaryTotalElem.textContent = primaryTotal;
    if (secondaryTotalElem) secondaryTotalElem.textContent = secondaryTotal;

    const vivaPracticalTotal = {{ candidate.viva_1 }} + {{ candidate.viva_2 }} + {{ candidate.practical_1 }} + {{ candidate.practical_2 }};
    const grandTotal = vivaPracticalTotal + primaryTotal + secondaryTotal;
    if (summaryTotalElem) summaryTotalElem.textContent = grandTotal;
  }

  updateTotals();
  updateSubmitButton();
  
  form.addEventListener('submit', function(e) {
    let hasErrors = false;
    marksInputs.forEach(input => {
      const value = input.value.trim();
      const maxMarks = parseInt(input.getAttribute('data-max-marks'));
      if (value !== "") {
        const numericValue = parseInt(value);
        if (isNaN(numericValue) || numericValue < 0 || numericValue > maxMarks) {
          hasErrors = true;
          input.style.borderColor = 'red';
        } else {
          input.style.borderColor = '';
        }
      }
    });
    if (hasErrors) {
      e.preventDefault();
      alert('Please fix the invalid marks before submitting.');
    }
  });
});
</script>
{% endblock %}
